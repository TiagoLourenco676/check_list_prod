<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check List CQ Produ√ß√£o - Office 365</title>
    
    <!-- Microsoft Graph SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-graph-client/3.0.7/graph-js-sdk.min.js"></script>
    <!-- MSAL Browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/msal-browser/3.8.0/msal-browser.min.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .office365-status {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .office365-status.connected {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        .office365-status.disconnected {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .header-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .info-group {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .info-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
        }

        .legend {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 3px solid #e9ecef;
        }

        .legend h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.3em;
        }

        .legend-items {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .legend-ok { border-left: 4px solid #27ae60; }
        .legend-atencao { border-left: 4px solid #f39c12; }
        .legend-nok { border-left: 4px solid #e74c3c; }

        .checklist-container {
            padding: 30px;
            overflow-x: auto;
        }

        .new-verification-section {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
        }

        .btn-new-verification {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-new-verification:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .image-upload-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            border: 2px dashed #3498db;
        }

        .image-upload-section input[type="file"] {
            display: none;
        }

        .image-upload-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .image-preview {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .image-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }

        .image-container img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 5px;
            border: 2px solid #ddd;
            margin-bottom: 8px;
        }

        .image-legend {
            width: 120px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            resize: none;
        }

        .image-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-delete-btn:hover {
            background: #c0392b;
        }

        .checklist-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .checklist-table th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 15px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 120px;
        }

        .checklist-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .checklist-table tr:hover {
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .hour-cell {
            font-weight: bold;
            font-size: 16px;
            background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
            color: #2c3e50;
            position: relative;
        }

        .delete-row-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .checklist-table tr:hover .delete-row-btn {
            display: flex;
        }

        .op-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .status-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .status-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .btn-ok { 
            background: #27ae60; 
            color: white; 
        }
        
        .btn-ok:hover:not(.active) {
            background: #2ecc71;
            transform: scale(1.05);
        }
        
        .btn-atencao { 
            background: #f39c12; 
            color: white; 
        }
        
        .btn-atencao:hover:not(.active) {
            background: #e67e22;
            transform: scale(1.05);
        }
        
        .btn-nok { 
            background: #e74c3c; 
            color: white; 
        }
        
        .btn-nok:hover:not(.active) {
            background: #c0392b;
            transform: scale(1.05);
        }

        .status-btn:hover.active {
            opacity: 0.8;
            cursor: pointer;
        }

        .btn-ok.active {
            background: #2ecc71;
            box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.5);
            transform: scale(1.2);
            animation: pulse-green 2s infinite;
        }

        .btn-atencao.active {
            background: #e67e22;
            box-shadow: 0 0 0 4px rgba(230, 126, 34, 0.5);
            transform: scale(1.2);
            animation: pulse-yellow 2s infinite;
        }

        .btn-nok.active {
            background: #c0392b;
            box-shadow: 0 0 0 4px rgba(192, 57, 43, 0.5);
            transform: scale(1.2);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(46, 204, 113, 0.2); }
        }

        @keyframes pulse-yellow {
            0%, 100% { box-shadow: 0 0 0 4px rgba(230, 126, 34, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(230, 126, 34, 0.2); }
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 4px rgba(192, 57, 43, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(192, 57, 43, 0.2); }
        }

        .obs-input {
            width: 150px;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .actions {
            padding: 30px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-office365 {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
        }

        .btn-save {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .btn-import {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
        }

        .btn-pdf {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }

        .btn-print {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-clear {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .save-status {
            text-align: center;
            padding: 12px 20px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            font-size: 14px;
            color: #6c757d;
            min-width: 250px;
            font-weight: 500;
        }

        .save-status.saved {
            color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid rgba(39, 174, 96, 0.2);
        }

        .save-status.error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .summary {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            text-align: center;
        }

        .summary-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 120px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-ok .stat-number { color: #27ae60; }
        .stat-atencao .stat-number { color: #f39c12; }
        .stat-nok .stat-number { color: #e74c3c; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .file-input { display: none; }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #27ae60;
            color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .header-info {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
                width: 100%;
            }
            
            .action-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CHECK LIST CQ PRODU√á√ÉO</h1>
            <div class="office365-status" id="officeStatus">
                <span id="officeStatusIcon">üîå</span>
                <span id="officeStatusText">Conectando ao Office 365...</span>
                <button class="btn-office365" id="connectBtn" onclick="connectToOffice365()" style="display: none;">
                    Conectar Office 365
                </button>
            </div>
            <div class="header-info">
                <div class="info-group">
                    <label for="data">Data:</label>
                    <input type="date" id="data" name="data">
                </div>
                <div class="info-group">
                    <label for="verificador">Verificador:</label>
                    <input type="text" id="verificador" name="verificador" placeholder="Nome do verificador">
                </div>
            </div>
        </div>

        <div class="legend">
            <h3>Legenda de Avalia√ß√£o</h3>
            <div class="legend-items">
                <div class="legend-item legend-ok">
                    <span class="status-btn btn-ok">‚úì</span>
                    <span>OK</span>
                </div>
                <div class="legend-item legend-atencao">
                    <span class="status-btn btn-atencao">‚ö†</span>
                    <span>ATEN√á√ÉO</span>
                </div>
                <div class="legend-item legend-nok">
                    <span class="status-btn btn-nok">‚úó</span>
                    <span>N√ÉO OK</span>
                </div>
            </div>
        </div>

        <div class="checklist-container">
            <div class="new-verification-section">
                <button class="btn-new-verification" onclick="addNewVerification()">
                    ‚ûï Nova Verifica√ß√£o
                </button>
                <p style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                    üí° Dica: Clique nos bot√µes coloridos para marcar status. Clique novamente para desmarcar.
                </p>
                <div class="image-upload-section">
                    <button class="image-upload-btn" onclick="document.getElementById('imageUpload').click()">
                        üì∑ Adicionar Fotos
                    </button>
                    <input type="file" id="imageUpload" multiple accept="image/*" onchange="handleImageUpload(event)">
                    <span style="font-size: 12px; color: #666;">Evid√™ncias, n√£o conformidades, etc.</span>
                    <div class="image-preview" id="imagePreview"></div>
                </div>
            </div>

            <table class="checklist-table" id="checklistTable">
                <thead>
                    <tr>
                        <th>HORA</th>
                        <th>O.P</th>
                        <th>COMPARA√á√ÉO MATERIAIS O.P E B.O.M UTILIZADOS</th>
                        <th>PROCESSOS/INSTRU√á√ÉO DE TRABALHO</th>
                        <th>MATRIZ DE COMPET√äNCIA</th>
                        <th>ETIQUETAS</th>
                        <th>OBSERVA√á√ïES</th>
                    </tr>
                </thead>
                <tbody id="checklistBody">
                    <tr class="empty-state">
                        <td colspan="7">
                            <div class="empty-state-icon">üìù</div>
                            <div>Nenhuma verifica√ß√£o adicionada</div>
                            <div>Clique em "Nova Verifica√ß√£o" para come√ßar</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="summary" id="summary">
                <h3>Resumo da Verifica√ß√£o</h3>
                <div class="summary-stats">
                    <div class="stat-item stat-ok">
                        <div class="stat-number" id="countOk">0</div>
                        <div>OK</div>
                    </div>
                    <div class="stat-item stat-atencao">
                        <div class="stat-number" id="countAtencao">0</div>
                        <div>ATEN√á√ÉO</div>
                    </div>
                    <div class="stat-item stat-nok">
                        <div class="stat-number" id="countNok">0</div>
                        <div>N√ÉO OK</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="actions">
            <div class="save-status" id="saveStatus">
                üíæ Sistema pronto para salvar
            </div>
            
            <div class="action-buttons">
                <button class="action-btn btn-save" onclick="saveToOneDrive()">‚òÅÔ∏è Salvar OneDrive</button>
                <button class="action-btn btn-save" onclick="saveData()">üíæ Salvar Local</button>
                <button class="action-btn btn-export" onclick="exportData()">üì• Exportar</button>
                <button class="action-btn btn-import" onclick="document.getElementById('importFile').click()">üì§ Importar</button>
                <button class="action-btn btn-pdf" onclick="generatePDF()">üìÑ PDF</button>
                <button class="action-btn btn-office365" onclick="sendReportByEmail()">üìß Enviar Relat√≥rio</button>
                <button class="action-btn btn-clear" onclick="clearAll()">üóëÔ∏è Limpar</button>
            </div>
            
            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ===== CONFIGURA√á√ÉO MICROSOFT GRAPH =====
        
        // IMPORTANTE: Configure estes valores no Azure AD
        const msalConfig = {
            auth: {
                clientId: 'SEU_CLIENT_ID_AQUI', // Substitua pelo Client ID do Azure AD
                authority: 'https://login.microsoftonline.com/SEU_TENANT_ID_AQUI', // Substitua pelo Tenant ID
                redirectUri: window.location.origin // URL atual
            },
            cache: {
                cacheLocation: 'localStorage',
                storeAuthStateInCookie: false
            }
        };

        // Permiss√µes necess√°rias
        const graphScopes = {
            scopes: [
                'User.Read',
                'Files.ReadWrite',
                'Sites.ReadWrite.All',
                'Mail.Send'
            ]
        };

        let msalInstance;
        let graphClient;
        let currentUser = null;
        
        // Vari√°veis do sistema
        let verificationCounter = 0;
        let uploadedImages = [];
        const colunas = ['materiais', 'processos', 'competencia', 'etiquetas'];

        // ===== INICIALIZA√á√ÉO =====
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeMSAL();
            document.getElementById('data').value = new Date().toISOString().split('T')[0];
            loadData();
        });

        async function initializeMSAL() {
            try {
                // Verificar se as configura√ß√µes est√£o definidas
                if (msalConfig.auth.clientId === 'SEU_CLIENT_ID_AQUI') {
                    updateOfficeStatus('disconnected', '‚ö†Ô∏è', 'Configura√ß√£o necess√°ria', true);
                    return;
                }

                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                
                // Verificar se h√° conta logada
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    currentUser = accounts[0];
                    await initializeGraphClient();
                    updateOfficeStatus('connected', '‚úÖ', `Conectado: ${currentUser.name}`, false);
                    document.getElementById('verificador').value = currentUser.name;
                } else {
                    updateOfficeStatus('disconnected', 'üîå', 'Clique para conectar', true);
                }
            } catch (error) {
                console.error('Erro ao inicializar MSAL:', error);
                updateOfficeStatus('disconnected', '‚ùå', 'Erro de configura√ß√£o', true);
            }
        }

        async function connectToOffice365() {
            try {
                updateOfficeStatus('connecting', '‚è≥', 'Conectando...', false);
                
                const response = await msalInstance.loginPopup(graphScopes);
                currentUser = response.account;
                
                await initializeGraphClient();
                updateOfficeStatus('connected', '‚úÖ', `Conectado: ${currentUser.name}`, false);
                document.getElementById('verificador').value = currentUser.name;
                
                showToast('Conectado ao Office 365 com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro na autentica√ß√£o:', error);
                updateOfficeStatus('disconnected', '‚ùå', 'Erro na conex√£o', true);
                showToast('Erro ao conectar com Office 365', 'error');
            }
        }

        async function initializeGraphClient() {
            class MSALAuthProvider {
                async getAccessToken() {
                    try {
                        const response = await msalInstance.acquireTokenSilent({
                            ...graphScopes,
                            account: currentUser
                        });
                        return response.accessToken;
                    } catch (error) {
                        // Se silent falhar, tenta interativo
                        const response = await msalInstance.acquireTokenPopup(graphScopes);
                        return response.accessToken;
                    }
                }
            }

            const authProvider = new MSALAuthProvider();
            graphClient = MicrosoftGraph.Client.initWithMiddleware({ authProvider });
        }

        function updateOfficeStatus(status, icon, text, showButton) {
            const statusEl = document.getElementById('officeStatus');
            const iconEl = document.getElementById('officeStatusIcon');
            const textEl = document.getElementById('officeStatusText');
            const btnEl = document.getElementById('connectBtn');
            
            iconEl.textContent = icon;
            textEl.textContent = text;
            btnEl.style.display = showButton ? 'inline-block' : 'none';
            
            statusEl.className = `office365-status ${status}`;
        }

        // ===== FUNCIONALIDADES CORE =====
        
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        function addNewVerification() {
            const tbody = document.getElementById('checklistBody');
            
            const emptyState = tbody.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            verificationCounter++;
            const currentTime = getCurrentTime();
            
            const row = document.createElement('tr');
            row.setAttribute('data-verification-id', verificationCounter);
            row.setAttribute('data-timestamp', Date.now());
            
            // Coluna de hora
            const horaCell = document.createElement('td');
            horaCell.className = 'hour-cell';
            horaCell.textContent = currentTime;
            horaCell.innerHTML += `<button class="delete-row-btn" onclick="deleteVerification(${verificationCounter})" title="Excluir verifica√ß√£o">√ó</button>`;
            row.appendChild(horaCell);

            // Coluna O.P
            const opCell = document.createElement('td');
            opCell.innerHTML = `<input type="text" class="op-input" placeholder="O.P">`;
            row.appendChild(opCell);

            // Colunas de verifica√ß√£o
            colunas.forEach(coluna => {
                const cell = document.createElement('td');
                cell.innerHTML = `
                    <div class="status-buttons">
                        <button class="status-btn btn-ok" onclick="setStatus(this, 'ok')" title="OK - Clique para marcar/desmarcar">‚úì</button>
                        <button class="status-btn btn-atencao" onclick="setStatus(this, 'atencao')" title="Aten√ß√£o - Clique para marcar/desmarcar">‚ö†</button>
                        <button class="status-btn btn-nok" onclick="setStatus(this, 'nok')" title="N√£o OK - Clique para marcar/desmarcar">‚úó</button>
                    </div>
                `;
                row.appendChild(cell);
            });

            // Coluna de observa√ß√µes
            const obsCell = document.createElement('td');
            obsCell.innerHTML = `<input type="text" class="obs-input" placeholder="Observa√ß√µes">`;
            row.appendChild(obsCell);

            tbody.appendChild(row);
            
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            setTimeout(() => {
                const opInput = row.querySelector('.op-input');
                if (opInput) {
                    opInput.focus();
                }
            }, 300);

            showToast('Nova verifica√ß√£o adicionada!', 'success');
            updateSummary();
        }

        function deleteVerification(verificationId) {
            if (confirm('Tem certeza que deseja excluir esta verifica√ß√£o?')) {
                const row = document.querySelector(`tr[data-verification-id="${verificationId}"]`);
                if (row) {
                    row.remove();
                    updateSummary();
                    
                    const tbody = document.getElementById('checklistBody');
                    if (tbody.children.length === 0) {
                        showEmptyState();
                    }
                    
                    showToast('Verifica√ß√£o exclu√≠da!', 'success');
                }
            }
        }

        function showEmptyState() {
            const tbody = document.getElementById('checklistBody');
            tbody.innerHTML = `
                <tr class="empty-state">
                    <td colspan="7">
                        <div class="empty-state-icon">üìù</div>
                        <div>Nenhuma verifica√ß√£o adicionada</div>
                        <div>Clique em "Nova Verifica√ß√£o" para come√ßar</div>
                    </td>
                </tr>
            `;
        }

        function setStatus(button, status) {
            const buttons = button.parentElement.querySelectorAll('.status-btn');
            
            // Se o bot√£o j√° est√° ativo, remover a sele√ß√£o
            if (button.classList.contains('active')) {
                button.classList.remove('active');
            } else {
                // Remover active de todos os bot√µes
                buttons.forEach(btn => btn.classList.remove('active'));
                // Adicionar active ao bot√£o clicado
                button.classList.add('active');
            }
            
            updateSummary();
        }

        function updateSummary() {
            const activeButtons = document.querySelectorAll('.status-btn.active');
            let countOk = 0, countAtencao = 0, countNok = 0;

            activeButtons.forEach(btn => {
                if (btn.classList.contains('btn-ok')) countOk++;
                else if (btn.classList.contains('btn-atencao')) countAtencao++;
                else if (btn.classList.contains('btn-nok')) countNok++;
            });

            document.getElementById('countOk').textContent = countOk;
            document.getElementById('countAtencao').textContent = countAtencao;
            document.getElementById('countNok').textContent = countNok;
        }

        // ===== UPLOAD DE IMAGENS =====
        
        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            const preview = document.getElementById('imagePreview');
            
            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageId = Date.now() + index;
                        
                        // Criar container da imagem
                        const container = document.createElement('div');
                        container.className = 'image-container';
                        container.setAttribute('data-image-id', imageId);
                        
                        // Criar imagem
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.title = file.name;
                        
                        // Criar campo de legenda
                        const legend = document.createElement('textarea');
                        legend.className = 'image-legend';
                        legend.placeholder = 'Adicionar legenda...';
                        legend.rows = 2;
                        
                        // Criar bot√£o de exclus√£o
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'image-delete-btn';
                        deleteBtn.innerHTML = '√ó';
                        deleteBtn.title = 'Excluir imagem';
                        deleteBtn.onclick = () => deleteImage(imageId);
                        
                        // Montar container
                        container.appendChild(deleteBtn);
                        container.appendChild(img);
                        container.appendChild(legend);
                        preview.appendChild(container);
                        
                        // Adicionar aos dados
                        uploadedImages.push({
                            id: imageId,
                            name: file.name,
                            data: e.target.result,
                            file: file,
                            legend: ''
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            showToast(`${files.length} imagem(ns) adicionada(s)!`, 'success');
            
            // Limpar input para permitir selecionar as mesmas imagens novamente
            event.target.value = '';
        }

        function deleteImage(imageId) {
            // Remover do array
            uploadedImages = uploadedImages.filter(img => img.id !== imageId);
            
            // Remover do DOM
            const container = document.querySelector(`[data-image-id="${imageId}"]`);
            if (container) {
                container.remove();
            }
            
            showToast('Imagem removida!', 'success');
        }

        function updateImageLegends() {
            // Atualizar legendas no array baseado nos campos de texto
            const containers = document.querySelectorAll('.image-container');
            containers.forEach(container => {
                const imageId = parseInt(container.getAttribute('data-image-id'));
                const legend = container.querySelector('.image-legend').value;
                
                const imageData = uploadedImages.find(img => img.id === imageId);
                if (imageData) {
                    imageData.legend = legend;
                }
            });
        }

        // ===== INTEGRA√á√ÉO OFFICE 365 =====
        
        async function saveToOneDrive() {
            if (!graphClient) {
                showToast('Conecte-se ao Office 365 primeiro!', 'error');
                return;
            }

            try {
                updateSaveStatus('loading');
                
                // Preparar dados
                const data = prepareDataForSave();
                data.savedToOneDrive = true;
                data.oneDrivePath = '/CheckList_CQ';
                
                // Nome do arquivo
                const dateStr = data.data.replace(/-/g, '');
                const verificador = data.verificador.replace(/[^a-zA-Z0-9]/g, '_');
                const fileName = `CheckList_CQ_${dateStr}_${verificador}.json`;
                
                // Salvar JSON no OneDrive
                const jsonBlob = new Blob([JSON.stringify(data, null, 2)], { 
                    type: 'application/json' 
                });
                
                await graphClient
                    .api(`/me/drive/root:/CheckList_CQ/${fileName}:/content`)
                    .put(jsonBlob);
                
                // Upload das imagens se houver
                if (uploadedImages.length > 0) {
                    await uploadImagesToOneDrive(dateStr, verificador);
                }
                
                updateSaveStatus('saved');
                showToast('Dados salvos no OneDrive com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao salvar no OneDrive:', error);
                updateSaveStatus('error');
                showToast('Erro ao salvar no OneDrive!', 'error');
            }
        }

        async function uploadImagesToOneDrive(dateStr, verificador) {
            const folderPath = `/CheckList_CQ/Imagens_${dateStr}_${verificador}`;
            
            // Criar pasta se n√£o existir
            try {
                await graphClient
                    .api(`/me/drive/root:${folderPath}`)
                    .get();
            } catch {
                await graphClient
                    .api('/me/drive/root/children')
                    .post({
                        name: `Imagens_${dateStr}_${verificador}`,
                        folder: {}
                    });
            }
            
            // Upload de cada imagem
            for (const image of uploadedImages) {
                const response = await fetch(image.data);
                const blob = await response.blob();
                
                await graphClient
                    .api(`/me/drive/root:${folderPath}/${image.name}:/content`)
                    .put(blob);
            }
        }

        async function sendReportByEmail() {
            if (!graphClient) {
                showToast('Conecte-se ao Office 365 primeiro!', 'error');
                return;
            }

            try {
                const data = document.getElementById('data').value;
                const verificador = document.getElementById('verificador').value;
                const countOk = document.getElementById('countOk').textContent;
                const countAtencao = document.getElementById('countAtencao').textContent;
                const countNok = document.getElementById('countNok').textContent;
                
                const emailBody = `
                    <h2>Relat√≥rio Check List CQ Produ√ß√£o</h2>
                    <p><strong>Data:</strong> ${data}</p>
                    <p><strong>Verificador:</strong> ${verificador}</p>
                    
                    <h3>Resumo:</h3>
                    <ul>
                        <li style="color: #27ae60;"><strong>OK:</strong> ${countOk}</li>
                        <li style="color: #f39c12;"><strong>Aten√ß√£o:</strong> ${countAtencao}</li>
                        <li style="color: #e74c3c;"><strong>N√£o OK:</strong> ${countNok}</li>
                    </ul>
                    
                    <p>Relat√≥rio gerado automaticamente pelo sistema Check List CQ.</p>
                `;

                const mail = {
                    subject: `Check List CQ - ${data} - ${verificador}`,
                    body: {
                        contentType: 'html',
                        content: emailBody
                    },
                    toRecipients: [
                        {
                            emailAddress: {
                                address: 'supervisor@empresa.com' // Configure o email do supervisor
                            }
                        }
                    ]
                };

                await graphClient.api('/me/sendMail').post({ message: mail });
                showToast('Relat√≥rio enviado por email!', 'success');
                
            } catch (error) {
                console.error('Erro ao enviar email:', error);
                showToast('Erro ao enviar email!', 'error');
            }
        }

        // ===== SISTEMA DE SALVAMENTO =====
        
        function prepareDataForSave() {
            // Atualizar legendas antes de salvar
            updateImageLegends();
            
            const data = {
                data: document.getElementById('data').value,
                verificador: document.getElementById('verificador').value,
                verificationCounter: verificationCounter,
                images: uploadedImages.map(img => ({ 
                    id: img.id,
                    name: img.name, 
                    data: img.data,
                    legend: img.legend || ''
                })),
                checklist: []
            };

            const rows = document.querySelectorAll('#checklistBody tr:not(.empty-state)');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const opValue = cells[1]?.querySelector('.op-input')?.value || '';
                    const obsValue = cells[cells.length - 1]?.querySelector('.obs-input')?.value || '';
                    
                    let hasStatus = false;
                    const verificacoes = [];
                    for (let i = 2; i < cells.length - 1; i++) {
                        const activeBtn = cells[i]?.querySelector('.status-btn.active');
                        let status = null;
                        if (activeBtn?.classList.contains('btn-ok')) {
                            status = 'ok';
                            hasStatus = true;
                        } else if (activeBtn?.classList.contains('btn-atencao')) {
                            status = 'atencao';
                            hasStatus = true;
                        } else if (activeBtn?.classList.contains('btn-nok')) {
                            status = 'nok';
                            hasStatus = true;
                        }
                        verificacoes.push(status);
                    }

                    const hasData = opValue.trim() !== '' || hasStatus || obsValue.trim() !== '';
                    
                    if (hasData) {
                        const rowData = {
                            verificationId: row.getAttribute('data-verification-id'),
                            timestamp: row.getAttribute('data-timestamp') || Date.now(),
                            hora: cells[0]?.textContent.replace('√ó', '').trim() || '',
                            op: opValue,
                            verificacoes: verificacoes,
                            observacoes: obsValue
                        };
                        
                        data.checklist.push(rowData);
                    }
                }
            });

            data.checklist.sort((a, b) => parseInt(a.timestamp) - parseInt(b.timestamp));
            data.savedAt = new Date().toISOString();
            data.version = '2.0';

            return data;
        }

        function saveData() {
            try {
                const data = prepareDataForSave();
                localStorage.setItem('checklist_cq_producao', JSON.stringify(data));
                updateSaveStatus('saved');
                showToast('Dados salvos localmente!', 'success');
            } catch (error) {
                console.error('Erro ao salvar:', error);
                updateSaveStatus('error');
                showToast('Erro ao salvar dados!', 'error');
            }
        }

        function loadData() {
            try {
                updateSaveStatus('loading');
                
                const saved = localStorage.getItem('checklist_cq_producao');
                if (saved) {
                    const data = JSON.parse(saved);
                    document.getElementById('data').value = data.data || '';
                    document.getElementById('verificador').value = data.verificador || '';
                    verificationCounter = data.verificationCounter || 0;
                    
                    // Carregar imagens
                    if (data.images) {
                        uploadedImages = data.images.map(img => ({
                            id: img.id || Date.now() + Math.random(),
                            name: img.name,
                            data: img.data,
                            legend: img.legend || ''
                        }));
                        
                        const preview = document.getElementById('imagePreview');
                        preview.innerHTML = '';
                        
                        uploadedImages.forEach(image => {
                            // Criar container da imagem
                            const container = document.createElement('div');
                            container.className = 'image-container';
                            container.setAttribute('data-image-id', image.id);
                            
                            // Criar imagem
                            const img = document.createElement('img');
                            img.src = image.data;
                            img.title = image.name;
                            
                            // Criar campo de legenda
                            const legend = document.createElement('textarea');
                            legend.className = 'image-legend';
                            legend.placeholder = 'Adicionar legenda...';
                            legend.rows = 2;
                            legend.value = image.legend || '';
                            
                            // Criar bot√£o de exclus√£o
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'image-delete-btn';
                            deleteBtn.innerHTML = '√ó';
                            deleteBtn.title = 'Excluir imagem';
                            deleteBtn.onclick = () => deleteImage(image.id);
                            
                            // Montar container
                            container.appendChild(deleteBtn);
                            container.appendChild(img);
                            container.appendChild(legend);
                            preview.appendChild(container);
                        });
                    }
                    
                    // Carregar checklist
                    if (data.checklist && data.checklist.length > 0) {
                        const tbody = document.getElementById('checklistBody');
                        tbody.innerHTML = '';
                        
                        const sortedChecklist = data.checklist.sort((a, b) => {
                            const timestampA = parseInt(a.timestamp) || 0;
                            const timestampB = parseInt(b.timestamp) || 0;
                            return timestampA - timestampB;
                        });
                        
                        sortedChecklist.forEach(rowData => {
                            const hasData = rowData.op.trim() !== '' || 
                                           rowData.verificacoes.some(v => v !== null) || 
                                           rowData.observacoes.trim() !== '';
                            
                            if (hasData) {
                                const row = document.createElement('tr');
                                row.setAttribute('data-verification-id', rowData.verificationId || Date.now());
                                row.setAttribute('data-timestamp', rowData.timestamp || Date.now());
                                
                                // Hora
                                const horaCell = document.createElement('td');
                                horaCell.className = 'hour-cell';
                                horaCell.textContent = rowData.hora;
                                horaCell.innerHTML += `<button class="delete-row-btn" onclick="deleteVerification(${rowData.verificationId})" title="Excluir verifica√ß√£o">√ó</button>`;
                                row.appendChild(horaCell);

                                // O.P
                                const opCell = document.createElement('td');
                                opCell.innerHTML = `<input type="text" class="op-input" placeholder="O.P" value="${rowData.op}">`;
                                row.appendChild(opCell);

                                // Verifica√ß√µes
                                rowData.verificacoes.forEach((status, index) => {
                                    const cell = document.createElement('td');
                                    cell.innerHTML = `
                                        <div class="status-buttons">
                                            <button class="status-btn btn-ok ${status === 'ok' ? 'active' : ''}" onclick="setStatus(this, 'ok')" title="OK - Clique para marcar/desmarcar">‚úì</button>
                                            <button class="status-btn btn-atencao ${status === 'atencao' ? 'active' : ''}" onclick="setStatus(this, 'atencao')" title="Aten√ß√£o - Clique para marcar/desmarcar">‚ö†</button>
                                            <button class="status-btn btn-nok ${status === 'nok' ? 'active' : ''}" onclick="setStatus(this, 'nok')" title="N√£o OK - Clique para marcar/desmarcar">‚úó</button>
                                        </div>
                                    `;
                                    row.appendChild(cell);
                                });

                                // Observa√ß√µes
                                const obsCell = document.createElement('td');
                                obsCell.innerHTML = `<input type="text" class="obs-input" placeholder="Observa√ß√µes" value="${rowData.observacoes}">`;
                                row.appendChild(obsCell);

                                tbody.appendChild(row);
                            }
                        });
                    }
                    
                    updateSummary();
                    
                    if (data.savedAt) {
                        const lastSaved = new Date(data.savedAt).toLocaleString('pt-BR');
                        updateSaveStatus('saved');
                        document.getElementById('saveStatus').textContent = `‚úÖ √öltimo salvamento: ${lastSaved}`;
                    } else {
                        updateSaveStatus('saved');
                    }
                    
                } else {
                    updateSaveStatus();
                }
                
            } catch (error) {
                console.error('Erro ao carregar:', error);
                updateSaveStatus('error');
                showToast('Erro ao carregar dados!', 'error');
            }
        }

        function updateSaveStatus(status) {
            const saveStatusEl = document.getElementById('saveStatus');
            const now = new Date().toLocaleString('pt-BR');
            
            switch (status) {
                case 'saved':
                    saveStatusEl.textContent = `‚úÖ Salvo em: ${now}`;
                    saveStatusEl.className = 'save-status saved';
                    break;
                case 'error':
                    saveStatusEl.textContent = `‚ùå Erro ao salvar em: ${now}`;
                    saveStatusEl.className = 'save-status error';
                    break;
                case 'loading':
                    saveStatusEl.textContent = `‚è≥ Processando...`;
                    saveStatusEl.className = 'save-status';
                    break;
                default:
                    saveStatusEl.textContent = `üíæ Sistema pronto para salvar`;
                    saveStatusEl.className = 'save-status';
            }
        }

        // ===== EXPORT/IMPORT =====
        
        function exportData() {
            try {
                const data = prepareDataForSave();
                data.exportedAt = new Date().toISOString();
                data.exportVersion = '2.0';
                data.appName = 'Check List CQ Produ√ß√£o - Office 365';

                const blob = new Blob([JSON.stringify(data, null, 2)], { 
                    type: 'application/json' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const verificador = data.verificador ? data.verificador.replace(/[^a-zA-Z0-9]/g, '_') : 'Usuario';
                const fileName = `CheckList_CQ_${dateStr}_${verificador}.json`;
                
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Dados exportados com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao exportar:', error);
                showToast('Erro ao exportar dados!', 'error');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showToast('Por favor, selecione um arquivo JSON!', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.checklist || !Array.isArray(importedData.checklist)) {
                        showToast('Arquivo JSON inv√°lido!', 'error');
                        return;
                    }
                    
                    const message = `Importar dados do arquivo?\n\n` +
                                  `üìÖ Data: ${importedData.data || 'N√£o informada'}\n` +
                                  `üë§ Verificador: ${importedData.verificador || 'N√£o informado'}\n` +
                                  `üìä Verifica√ß√µes: ${importedData.checklist.length}\n` +
                                  `üì∑ Imagens: ${importedData.images ? importedData.images.length : 0}\n\n` +
                                  `‚ö†Ô∏è Isso substituir√° todos os dados atuais!`;
                    
                    if (confirm(message)) {
                        localStorage.setItem('checklist_cq_producao', JSON.stringify(importedData));
                        location.reload();
                    }
                    
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    showToast('Erro ao ler arquivo JSON!', 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        // ===== OUTRAS FUNCIONALIDADES =====
        
        function generatePDF() {
            // Atualizar legendas antes de gerar PDF
            updateImageLegends();
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            const data = document.getElementById('data').value;
            const verificador = document.getElementById('verificador').value;
            
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('CHECK LIST CQ PRODUCAO - OFFICE 365', 148, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Data: ${data || '_____/_____/_____'}`, 20, 35);
            doc.text(`Verificador: ${verificador || '________________________'}`, 150, 35);
            
            const tableData = [];
            const rows = document.querySelectorAll('#checklistBody tr:not(.empty-state)');
            
            rows.forEach((row) => {
                const cells = row.querySelectorAll('td');
                
                if (cells.length > 0) {
                    const rowData = [];
                    
                    const hora = cells[0].textContent.replace('√ó', '').trim();
                    rowData.push(hora);
                    
                    const opInput = cells[1].querySelector('.op-input');
                    rowData.push(opInput ? opInput.value : '');
                    
                    for (let i = 2; i < cells.length - 1; i++) {
                        const activeBtn = cells[i].querySelector('.status-btn.active');
                        let status = '';
                        
                        if (activeBtn?.classList.contains('btn-ok')) {
                            status = 'OK';
                        } else if (activeBtn?.classList.contains('btn-atencao')) {
                            status = 'ATENCAO';
                        } else if (activeBtn?.classList.contains('btn-nok')) {
                            status = 'NAO OK';
                        }
                        
                        rowData.push(status);
                    }
                    
                    const obsInput = cells[cells.length - 1].querySelector('.obs-input');
                    rowData.push(obsInput ? obsInput.value : '');
                    
                    tableData.push(rowData);
                }
            });
            
            const headers = [
                'HORA',
                'O.P',
                'MATERIAIS BOM',
                'PROCESSOS/INSTRUCAO',
                'MATRIZ COMPETENC.',
                'ETIQUETAS',
                'OBSERVACOES'
            ];
            
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 45,
                styles: {
                    fontSize: 8,
                    cellPadding: 3,
                    valign: 'middle',
                    halign: 'center'
                },
                headStyles: {
                    fillColor: [44, 62, 80],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 9
                },
                columnStyles: {
                    0: { cellWidth: 18, halign: 'center' }, // HORA
                    1: { cellWidth: 20, halign: 'center' }, // O.P
                    2: { cellWidth: 35, halign: 'center' }, // MATERIAIS (reduzido)
                    3: { cellWidth: 40, halign: 'center' }, // PROCESSOS/IT (aumentado)
                    4: { cellWidth: 35, halign: 'center' }, // MATRIZ (reduzido)
                    5: { cellWidth: 25, halign: 'center' }, // ETIQUETAS
                    6: { cellWidth: 45, halign: 'left' }    // OBSERVA√á√ïES
                },
                didParseCell: function(data) {
                    // Colorir c√©lulas baseado no status com cores mais vivas
                    if (data.cell.text[0]) {
                        if (data.cell.text[0] === 'OK') {
                            data.cell.styles.fillColor = [212, 237, 218]; // Verde mais vis√≠vel
                            data.cell.styles.textColor = [21, 87, 36];    // Verde escuro
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = 9;
                        } else if (data.cell.text[0] === 'ATENCAO') {
                            data.cell.styles.fillColor = [255, 243, 205]; // Amarelo mais vis√≠vel
                            data.cell.styles.textColor = [133, 100, 4];   // Amarelo escuro
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = 9;
                        } else if (data.cell.text[0] === 'NAO OK') {
                            data.cell.styles.fillColor = [248, 215, 218]; // Vermelho mais vis√≠vel
                            data.cell.styles.textColor = [114, 28, 36];   // Vermelho escuro
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = 9;
                        }
                    }
                    
                    // Destacar c√©lulas de hora
                    if (data.column.index === 0 && data.cell.text[0] && data.cell.text[0].includes(':')) {
                        data.cell.styles.fillColor = [236, 240, 241];
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [44, 62, 80];
                    }
                }
            });
            
            let finalY = doc.lastAutoTable.finalY + 15;
            
            // ===== ADICIONAR IMAGENS AO PDF =====
            if (uploadedImages.length > 0) {
                // T√≠tulo da se√ß√£o de imagens
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('EVID√äNCIAS FOTOGR√ÅFICAS', 148, finalY, { align: 'center' });
                finalY += 15;
                
                // Configura√ß√£o para layout das imagens
                const imageWidth = 60;  // largura da imagem no PDF
                const imageHeight = 45; // altura da imagem no PDF
                const imagesPerRow = 4;  // imagens por linha
                const imageSpacing = 70; // espa√ßamento entre imagens
                const rowSpacing = 65;   // espa√ßamento entre linhas
                
                let currentX = 20;
                let currentY = finalY;
                let imageCount = 0;
                
                for (const image of uploadedImages) {
                    try {
                        // Adicionar imagem
                        doc.addImage(
                            image.data, 
                            'JPEG', 
                            currentX, 
                            currentY, 
                            imageWidth, 
                            imageHeight
                        );
                        
                        // Adicionar legenda abaixo da imagem
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(0, 0, 0);
                        
                        const legendText = image.legend || image.name || 'Sem legenda';
                        const legendLines = doc.splitTextToSize(legendText, imageWidth);
                        doc.text(legendLines, currentX, currentY + imageHeight + 5);
                        
                        imageCount++;
                        
                        // Calcular posi√ß√£o da pr√≥xima imagem
                        if (imageCount % imagesPerRow === 0) {
                            // Nova linha
                            currentX = 20;
                            currentY += rowSpacing;
                            
                            // Verificar se precisa de nova p√°gina
                            if (currentY > 180) { // Pr√≥ximo da margem inferior
                                doc.addPage();
                                currentY = 20;
                            }
                        } else {
                            // Pr√≥xima coluna
                            currentX += imageSpacing;
                        }
                        
                    } catch (error) {
                        console.error('Erro ao adicionar imagem ao PDF:', error);
                    }
                }
                
                // Atualizar finalY para continuar ap√≥s as imagens
                finalY = currentY + (imageCount % imagesPerRow === 0 ? 0 : rowSpacing);
                
                // Se h√° imagens, garantir espa√ßo extra
                if (finalY < 180) {
                    finalY += 20;
                } else {
                    doc.addPage();
                    finalY = 20;
                }
            }
            
            // ===== RESUMO E LEGENDA =====
            // Verificar se h√° espa√ßo suficiente na p√°gina atual
            if (finalY > 160) { // Se est√° muito pr√≥ximo da margem inferior
                doc.addPage();
                finalY = 20;
            }
            
            // LEGENDA (lado esquerdo)
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('LEGENDA:', 20, finalY);
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            // OK com cor verde
            doc.setFillColor(212, 237, 218);
            doc.rect(20, finalY + 5, 5, 5, 'F');
            doc.setTextColor(21, 87, 36);
            doc.text('OK = Conforme', 28, finalY + 9);
            
            // ATEN√á√ÉO com cor amarela
            doc.setFillColor(255, 243, 205);
            doc.rect(20, finalY + 12, 5, 5, 'F');
            doc.setTextColor(133, 100, 4);
            doc.text('ATENCAO = Requer atencao', 28, finalY + 16);
            
            // N√ÉO OK com cor vermelha
            doc.setFillColor(248, 215, 218);
            doc.rect(20, finalY + 19, 5, 5, 'F');
            doc.setTextColor(114, 28, 36);
            doc.text('NAO OK = Nao conforme', 28, finalY + 23);
            
            // RESUMO (lado direito, posicionado adequadamente)
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMO:', 170, finalY);
            
            const countOk = document.getElementById('countOk').textContent;
            const countAtencao = document.getElementById('countAtencao').textContent;
            const countNok = document.getElementById('countNok').textContent;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            // Contadores do resumo com cores correspondentes
            doc.setFillColor(212, 237, 218);
            doc.rect(170, finalY + 5, 5, 5, 'F');
            doc.setTextColor(21, 87, 36);
            doc.text(`OK: ${countOk}`, 178, finalY + 9);
            
            doc.setFillColor(255, 243, 205);
            doc.rect(170, finalY + 12, 5, 5, 'F');
            doc.setTextColor(133, 100, 4);
            doc.text(`ATENCAO: ${countAtencao}`, 178, finalY + 16);
            
            doc.setFillColor(248, 215, 218);
            doc.rect(170, finalY + 19, 5, 5, 'F');
            doc.setTextColor(114, 28, 36);
            doc.text(`NAO OK: ${countNok}`, 178, finalY + 23);
            
            // Rodap√© (ajustado para nova posi√ß√£o)
            const footerY = finalY + 35;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('Gerado em: ' + new Date().toLocaleString('pt-BR'), 20, footerY);
            doc.text('Check List CQ Producao - Office 365 Integration', 148, footerY, { align: 'center' });
            
            if (uploadedImages.length > 0) {
                doc.text(`Evid√™ncias: ${uploadedImages.length} imagem(ns)`, 220, footerY);
            }
            
            // Salvar PDF
            const dataFormatted = data.replace(/-/g, '');
            const verificadorFormatted = verificador.replace(/[^a-zA-Z0-9]/g, '_').replace(/_+/g, '_');
            const fileName = `CheckList_CQ_${dataFormatted}_${verificadorFormatted || 'Verificador'}.pdf`;
            doc.save(fileName);
            
            showToast('PDF gerado com cores, imagens e layout otimizado!', 'success');
        }

        function clearAll() {
            if (confirm('Tem certeza que deseja limpar todos os dados?')) {
                document.getElementById('data').value = new Date().toISOString().split('T')[0];
                // Se conectado ao Office 365, manter o nome
                if (currentUser) {
                    document.getElementById('verificador').value = currentUser.name;
                } else {
                    document.getElementById('verificador').value = '';
                }
                
                const tbody = document.getElementById('checklistBody');
                showEmptyState();
                
                document.getElementById('imagePreview').innerHTML = '';
                uploadedImages = [];
                
                verificationCounter = 0;
                updateSummary();
                localStorage.removeItem('checklist_cq_producao');
                showToast('Dados limpos com sucesso!', 'success');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            
            if (type === 'error') {
                toast.style.background = '#e74c3c';
            } else {
                toast.style.background = '#27ae60';
            }
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Auto-save a cada 30 segundos
        setInterval(() => {
            const rows = document.querySelectorAll('#checklistBody tr:not(.empty-state)');
            let hasRealData = false;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const opValue = cells[1]?.querySelector('.op-input')?.value || '';
                    const obsValue = cells[cells.length - 1]?.querySelector('.obs-input')?.value || '';
                    const hasStatus = cells[2]?.querySelector('.status-btn.active') !== null;
                    
                    if (opValue.trim() !== '' || hasStatus || obsValue.trim() !== '') {
                        hasRealData = true;
                    }
                }
            });
            
            if (hasRealData) {
                try {
                    saveData();
                } catch (error) {
                    console.error('Erro no auto-save:', error);
                }
            }
        }, 30000);
    </script>
</body>
</html>
