function generatePDF() {
            // Atualizar legendas antes de gerar PDF
            updateImageLegends();
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            const data = document.getElementById('data').value;
            const verificador = document.getElementById('verificador').value;
            
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('CHECK LIST CQ PRODUCAO - OFFICE 365', 148, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Data: ${data || '_____/_____/_____'}`, 20, 35);
            doc.text(`Verificador: ${verificador || '________________________'}`, 150, 35);
            
            const tableData = [];
            const hourValidationData = []; // Array para armazenar informações de validação de horário
            const rows = document.querySelectorAll('#checklistBody tr:not(.empty-state)');
            
            rows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('td');
                
                if (cells.length > 0) {
                    const rowData = [];
                    
                    const hora = cells[0].textContent.replace('×', '').trim();
                    rowData.push(hora);
                    
                    // Capturar informação de validação de horário
                    const hourCell = cells[0];
                    let hourValidation = 'default';
                    if (hourCell.classList.contains('time-valid')) {
                        hourValidation = 'valid';
                    } else if (hourCell.classList.contains('time-warning')) {
                        hourValidation = 'warning';
                    } else if (hourCell.classList.contains('time-danger')) {
                        hourValidation = 'danger';
                    }
                    hourValidationData.push(hourValidation);
                    
                    const opInput = cells[1].querySelector('.op-input');
                    rowData.push(opInput ? opInput.value : '');
                    
                    for (let i = 2; i < cells.length - 1; i++) {
                        const activeBtn = cells[i].querySelector('.status-btn.active');
                        let status = '';
                        
                        if (activeBtn?.classList.contains('btn-ok')) {
                            status = 'OK';
                        } else if (activeBtn?.classList.contains('btn-atencao')) {
                            status = 'ATENCAO';
                        } else if (activeBtn?.classList.contains('btn-nok')) {
                            status = 'NAO OK';
                        }
                        
                        rowData.push(status);
                    }
                    
                    const obsInput = cells[cells.length - 1].querySelector('.obs-input');
                    rowData.push(obsInput ? obsInput.value : '');
                    
                    tableData.push(rowData);
                }
            });
            
            let finalY = doc.lastAutoTable.finalY + 15;
            
            // ===== ADICIONAR IMAGENS AO PDF =====
            if (uploadedImages.length > 0) {
                // Título da seção de imagens
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('EVIDÊNCIAS FOTOGRÁFICAS', 148, finalY, { align: 'center' });
                finalY += 15;
                
                // Configuração para layout das imagens
                const imageWidth = 60;  // largura da imagem no PDF
                const imageHeight = 45; // altura da imagem no PDF
                const imagesPerRow = 4;  // imagens por linha
                const imageSpacing = 70; // espaçamento entre imagens
                const rowSpacing = 65;   // espaçamento entre linhas
                
                let currentX = 20;
                let currentY = finalY;
                let imageCount = 0;
                
                for (const image of uploadedImages) {
                    try {
                        // Adicionar imagem
                        doc.addImage(
                            image.data, 
                            'JPEG', 
                            currentX, 
                            currentY, 
                            imageWidth, 
                            imageHeight
                        );
                        
                        // Adicionar legenda abaixo da imagem
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(0, 0, 0);
                        
                        const legendText = image.legend || image.name || 'Sem legenda';
                        const legendLines = doc.splitTextToSize(legendText, imageWidth);
                        doc.text(legendLines, currentX, currentY + imageHeight + 5);
                        
                        imageCount++;
                        
                        // Calcular posição da próxima imagem
                        if (imageCount % imagesPerRow === 0) {
                            // Nova linha
                            currentX = 20;
                            currentY += rowSpacing;
                            
                            // Verificar se precisa de nova página
                            if (currentY > 180) { // Próximo da margem inferior
                                doc.addPage();
                                currentY = 20;
                            }
                        } else {
                            // Próxima coluna
                            currentX += imageSpacing;
                        }
                        
                    } catch (error) {
                        console.error('Erro ao adicionar imagem ao PDF:', error);
                    }
                }
                
                // Atualizar finalY para continuar após as imagens
                finalY = currentY + (imageCount % imagesPerRow === 0 ? 0 : rowSpacing);
                
                // Se há imagens, garantir espaço extra
                if (finalY < 180) {
                    finalY += 20;
                } else {
                    doc.addPage();
                    finalY = 20;
                }
            }
            
            // ===== RESUMO E LEGENDA =====
            // Verificar se há espaço suficiente na página atual
            if (finalY > 160) { // Se está muito próximo da margem inferior
                doc.addPage();
                finalY = 20;
            }
            
            // LEGENDA (lado esquerdo)
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('LEGENDA:', 20, finalY);
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            // OK com cor verde
            doc.setFillColor(212, 237, 218);
            doc.rect(20, finalY + 5, 5, 5, 'F');
            doc.setTextColor(21, 87, 36);
            doc.text('OK = Conforme', 28, finalY + 9);
            
            // ATENÇÃO com cor amarela
            doc.setFillColor(255, 243, 205);
            doc.rect(20, finalY + 12, 5, 5, 'F');
            doc.setTextColor(133, 100, 4);
            doc.text('ATENCAO = Requer atencao', 28, finalY + 16);
            
            // NÃO OK com cor vermelha
            doc.setFillColor(248, 215, 218);
            doc.rect(20, finalY + 19, 5, 5, 'F');
            doc.setTextColor(114, 28, 36);
            doc.text('NAO OK = Nao conforme', 28, finalY + 23);
            
            // RESUMO (lado direito, posicionado adequadamente)
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMO:', 170, finalY);
            
            const countOk = document.getElementById('countOk').textContent;
            const countAtencao = document.getElementById('countAtencao').textContent;
            const countNok = document.getElementById('countNok').textContent;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            // Contadores do resumo com cores correspondentes
            doc.setFillColor(212, 237, 218);
            doc.rect(170, finalY + 5, 5, 5, 'F');
            doc.setTextColor(21, 87, 36);
            doc.text(`OK: ${countOk}`, 178, finalY + 9);
            
            doc.setFillColor(255, 243, 205);
            doc.rect(170, finalY + 12, 5, 5, 'F');
            doc.setTextColor(133, 100, 4);
            doc.text(`ATENCAO: ${countAtencao}`, 178, finalY + 16);
            
            doc.setFillColor(248, 215, 218);
            doc.rect(170, finalY + 19, 5, 5, 'F');
            doc.setTextColor(114, 28, 36);
            doc.text(`NAO OK: ${countNok}`, 178, finalY + 23);
            
            // Rodapé (ajustado para nova posição)
            const footerY = finalY + 35;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('Gerado em: ' + new Date().toLocaleString('pt-BR'), 20, footerY);
            doc.text('Check List CQ Producao - Office 365 Integration', 148, footerY, { align: 'center' });
            
            if (uploadedImages.length > 0) {
                doc.text(`Evidências: ${uploadedImages.length} imagem(ns)`, 220, footerY);
            }
            
            // Salvar PDF
            const dataFormatted = data.replace(/-/g, '');
            const verificadorFormatted = verificador.replace(/[^a-zA-Z0-9]/g, '_').replace(/_+/g, '_');
            const fileName = `CheckList_CQ_${dataFormatted}_${verificadorFormatted || 'Verificador'}.pdf`;
            doc.save(fileName);
            
            showToast('PDF gerado com cores, imagens e layout otimizado!', 'success');
        }
            
            const headers = [
                'HORA',
                'O.P',
                'MATERIAIS BOM',
                'PROCESSOS/INSTRUCAO',
                'MATRIZ COMPETENC.',
                'ETIQUETAS',
                'OBSERVACOES'
            ];
            
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 45,
                styles: {
                    fontSize: 8,
                    cellPadding: 3,
                    valign: 'middle',
                    halign: 'center'
                },
                headStyles: {
                    fillColor: [44, 62, 80],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 9
                },
                columnStyles: {
                    0: { cellWidth: 18, halign: 'center' }, // HORA
                    1: { cellWidth: 20, halign: 'center' }, // O.P
                    2: { cellWidth: 35, halign: 'center' }, // MATERIAIS (reduzido)
                    3: { cellWidth: 40, halign: 'center' }, // PROCESSOS/IT (aumentado)
                    4: { cellWidth: 35, halign: 'center' }, // MATRIZ (reduzido)
                    5: { cellWidth: 25, halign: 'center' }, // ETIQUETAS
                    6: { cellWidth: 45, halign: 'left' }    // OBSERVAÇÕES
                },
                didParseCell: function(data) {
                    // Colorir células baseado no status com cores mais vivas
                    if (data.cell.text[0]) {
                        if (data.cell.text[0] === 'OK') {
                            data.cell.styles.fillColor = [212, 237, 218]; // Verde mais visível
                            data.cell.styles.textColor = [21, 87, 36];    // Verde escuro
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = 9;
                        } else if (data.cell.text[0] === 'ATENCAO') {
                            data.cell.styles.fillColor = [255, 243, 205]; // Amarelo mais visível
                            data.cell.styles.textColor = [133, 100, 4];   // Amarelo escuro
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = 9;
                        } else if (data.cell.text[0] === 'NAO OK') {
                            data.cell.styles.fillColor = [248, 215, 218]; // Vermelho mais visível
                            data.cell.styles.textColor = [114, 28, 36];   // Vermelho escuro
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = 9;
                        }
                    }
                    
                    // Aplicar cores às células de hora baseado na validação de horário
                    if (data.column.index === 0 && data.cell.text[0] && data.cell.text[0].includes(':')) {
                        const rowIndex = data.row.index;
                        const validation = hourValidationData[rowIndex];
                        
                        if (validation === 'valid') {
                            // Verde - horário válido
                            data.cell.styles.fillColor = [212, 237, 218];
                            data.cell.styles.textColor = [21, 87, 36];
                            data.cell.styles.fontStyle = 'bold';
                        } else if (validation === 'warning') {
                            // Amarelo - horário com atenção
                            data.cell.styles.fillColor = [255, 243, 205];
                            data.cell.styles.textColor = [133, 100, 4];
                            data.cell.styles.fontStyle = 'bold';
                        } else if (validation === 'danger') {
                            // Vermelho - horário crítico
                            data.cell.styles.fillColor = [248, 215, 218];
                            data.cell.styles.textColor = [114, 28, 36];
                            data.cell.styles.fontStyle = 'bold';
                        } else {
                            // Cor padrão para horários sem validação específica
                            data.cell.styles.fillColor = [236, 240, 241];
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.textColor = [44, 62, 80];
                        }
                    }
                }
            });
